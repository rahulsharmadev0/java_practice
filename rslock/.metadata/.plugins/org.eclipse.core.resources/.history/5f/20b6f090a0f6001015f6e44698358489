package com.rslock.common;

import javax.crypto.Cipher;
import javax.crypto.CipherInputStream;
import javax.crypto.CipherOutputStream;
import javax.crypto.KeyGenerator;
import javax.crypto.SecretKey;
import javax.crypto.spec.IvParameterSpec;

import java.io.InputStream;
import java.io.OutputStream;
import java.security.*;
import java.security.cert.Certificate;

public class CypherUtility {
	
	private CypherUtility() {
		throw new UnsupportedOperationException("This is a utility class and cannot be instantiated");
	}

	/**
	 * Generate a new AES key with the specified key size
	 */
	public static SecretKey generateAESKey() throws NoSuchAlgorithmException {
		KeyGenerator keyGenerator = KeyGenerator.getInstance(CypherConstraints.AES_ALGORITHM);
		keyGenerator.init(CypherConstraints.AES_KEY_SIZE);
		return keyGenerator.generateKey();
	}

	/**
	 * Generate a random Initialization Vector (IV) for AES CBC mode
	 */
	public static IvParameterSpec generateIV() {
		byte[] ivBytes = new byte[CypherConstraints.IV_SIZE];
		SecureRandom random = new SecureRandom();
		random.nextBytes(ivBytes);
		return new IvParameterSpec(ivBytes);
	}

//    public static byte[] encryptAES(byte[] data, SecretKey key, IvParameterSpec iv) throws Exception {
//        Cipher cipher = Cipher.getInstance(CypherConstraints.AES_TRANSFORMATION);
//        cipher.init(Cipher.ENCRYPT_MODE, key, iv);
//        return cipher.doFinal(data);
//    }
//
//    public static byte[] decryptAES(byte[] encryptedData, SecretKey key, IvParameterSpec iv) throws Exception {
//        Cipher cipher = Cipher.getInstance(CypherConstraints.AES_TRANSFORMATION);
//        cipher.init(Cipher.DECRYPT_MODE, key, iv);
//        return cipher.doFinal(encryptedData);
//    }

	public static byte[] encryptAESKeyWithRSA(SecretKey aesKey, PublicKey publicKey) throws Exception {
		Cipher cipher = Cipher.getInstance(CypherConstraints.RSA_TRANSFORMATION);
		cipher.init(Cipher.ENCRYPT_MODE, publicKey);
		return cipher.doFinal(aesKey.getEncoded());
	}

	public static byte[] decryptAESKeyWithRSA(byte[] encryptedKey, PrivateKey privateKey) throws Exception {
		Cipher cipher = Cipher.getInstance(CypherConstraints.RSA_TRANSFORMATION);
		cipher.init(Cipher.DECRYPT_MODE, privateKey);
		return cipher.doFinal(encryptedKey);
	}

	public static CipherOutputStream encryptStream(OutputStream out, PrivateKey privateKey, IvParameterSpec iv)
			throws Exception {
		Cipher cipher = Cipher.getInstance(CypherConstraints.RSA_TRANSFORMATION);
		cipher.init(Cipher.ENCRYPT_MODE, privateKey, iv);
		return new CipherOutputStream(out, cipher);

	}

	public static CipherInputStream decryptStream(InputStream in, PrivateKey privateKey, IvParameterSpec iv)
			throws Exception {
		Cipher cipher = Cipher.getInstance(CypherConstraints.RSA_TRANSFORMATION);
		cipher.init(Cipher.DECRYPT_MODE, privateKey, iv);
		return new CipherInputStream(in, cipher);

	}

	/**
	 * Load Public Key from KeyStore
	 */
	public static PublicKey loadPublicKey(KeyStore keyStore, String alias) throws Exception {
		Certificate certificate = keyStore.getCertificate(alias);
		if (certificate == null) {
			throw new KeyStoreException("Certificate not found for alias: " + alias);
		}
		return certificate.getPublicKey();
	}

	/**
	 * Load Private Key from KeyStore
	 */
	public static PrivateKey loadPrivateKey(KeyStore keyStore, String alias, char[] password) throws Exception {
		Key key = keyStore.getKey(alias, password);
		if (!(key instanceof PrivateKey)) {
			throw new KeyStoreException("Private key not found for alias: " + alias);
		}
		return (PrivateKey) key;
	}

}
